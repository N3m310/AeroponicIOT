<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - AeroponicIOT</title>
    <link rel="stylesheet" href="css/register.css">
</head>

<body>
    <div class="register-container">
        <div class="register-card">
            <div class="register-header">
                <h1>AeroponicIOT</h1>
                <p>Create Your Account</p>
            </div>

            <form id="registerForm" class="register-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required placeholder="Enter your username">
                    <span class="error-message" id="usernameError"></span>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required placeholder="Enter your email">
                    <span class="error-message" id="emailError"></span>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required placeholder="Enter your password">
                    <span class="error-message" id="passwordError"></span>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required
                        placeholder="Confirm your password">
                    <span class="error-message" id="confirmPasswordError"></span>
                </div>

                <div class="form-group">
                    <label for="role">Role</label>
                    <select id="role" name="role" required>
                        <option value="">Select a role</option>
                        <option value="Farmer">Farmer</option>
                        <option value="Admin">Admin</option>
                    </select>
                    <span class="error-message" id="roleError"></span>
                </div>

                <div id="successMessage" class="success-message" style="display: none;">
                    <span id="successText"></span>
                </div>

                <div id="errorMessage" class="error-message-box" style="display: none;">
                    <span id="errorText"></span>
                </div>

                <button type="submit" class="btn-register">Register</button>
            </form>

            <div class="register-footer">
                <p>Already have an account? <a href="login.html">Login here</a></p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear previous messages
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            clearErrors();

            // Get form values
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('role').value;

            // Validate inputs
            let isValid = true;

            if (!username || username.length < 3) {
                showError('usernameError', 'Username must be at least 3 characters');
                isValid = false;
            }

            if (!email || !isValidEmail(email)) {
                showError('emailError', 'Please enter a valid email address');
                isValid = false;
            }

            if (!password || password.length < 6) {
                showError('passwordError', 'Password must be at least 6 characters');
                isValid = false;
            }

            if (password !== confirmPassword) {
                showError('confirmPasswordError', 'Passwords do not match');
                isValid = false;
            }

            if (!role) {
                showError('roleError', 'Please select a role');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const response = await fetch('/api/authentication/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        role: role
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    document.getElementById('successText').textContent = data.message || 'Registration successful! Redirecting to login...';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('registerForm').reset();

                    // Redirect to login after 2 seconds
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    document.getElementById('errorText').textContent = data.message || 'Registration failed. Please try again.';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                console.error('Registration error:', error);
                document.getElementById('errorText').textContent = 'An error occurred. Please try again.';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
            });
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
    </script>
</body>

</html>
