<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Đăng ký - AeroponicIOT</title>
    <link rel="stylesheet" href="css/register.css">
</head>

<body>
    <div class="register-container">
        <div class="register-card">
            <div class="register-header">
                <h1>AeroponicIOT</h1>
                <p>Tạo tài khoản của bạn</p>
            </div>

            <form id="registerForm" class="register-form">
                <div class="form-group">
                    <label for="username">Tên đăng nhập</label>
                    <input type="text" id="username" name="username" required placeholder="Nhập tên đăng nhập">
                    <span class="error-message" id="usernameError"></span>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required placeholder="Nhập email">
                    <span class="error-message" id="emailError"></span>
                </div>

                <div class="form-group">
                    <label for="password">Mật khẩu</label>
                    <input type="password" id="password" name="password" required placeholder="Nhập mật khẩu">
                    <span class="error-message" id="passwordError"></span>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Xác nhận mật khẩu</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required
                        placeholder="Nhập lại mật khẩu">
                    <span class="error-message" id="confirmPasswordError"></span>
                </div>

                <div class="form-group">
                    <label for="role">Vai trò</label>
                    <select id="role" name="role" required>
                        <option value="">Chọn vai trò</option>
                        <option value="Farmer">Nông dân</option>
                        <option value="Admin">Quản trị viên</option>
                    </select>
                    <span class="error-message" id="roleError"></span>
                </div>

                <div id="successMessage" class="success-message" style="display: none;">
                    <span id="successText"></span>
                </div>

                <div id="errorMessage" class="error-message-box" style="display: none;">
                    <span id="errorText"></span>
                </div>

                <button type="submit" class="btn-register">Đăng ký</button>
            </form>

            <div class="register-footer">
                <p>Đã có tài khoản? <a href="login.html">Đăng nhập tại đây</a></p>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear previous messages
            document.getElementById('successMessage').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            clearErrors();

            // Get form values
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('role').value;

            // Validate inputs
            let isValid = true;

            if (!username || username.length < 3) {
                showError('usernameError', 'Tên đăng nhập phải có ít nhất 3 ký tự');
                isValid = false;
            }

            if (!email || !isValidEmail(email)) {
                showError('emailError', 'Vui lòng nhập địa chỉ email hợp lệ');
                isValid = false;
            }

            if (!password || password.length < 6) {
                showError('passwordError', 'Mật khẩu phải có ít nhất 6 ký tự');
                isValid = false;
            }

            if (password !== confirmPassword) {
                showError('confirmPasswordError', 'Mật khẩu xác nhận không khớp');
                isValid = false;
            }

            if (!role) {
                showError('roleError', 'Vui lòng chọn vai trò');
                isValid = false;
            }

            if (!isValid) return;

            try {
                const response = await fetch('/api/authentication/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        email: email,
                        password: password,
                        role: role
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    document.getElementById('successText').textContent = data.message || 'Đăng ký thành công! Đang chuyển sang trang đăng nhập...';
                    document.getElementById('successMessage').style.display = 'block';
                    document.getElementById('registerForm').reset();

                    // Chuyển sang trang đăng nhập sau 2 giây
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                } else {
                    document.getElementById('errorText').textContent = data.message || 'Đăng ký thất bại. Vui lòng thử lại.';
                    document.getElementById('errorMessage').style.display = 'block';
                }
            } catch (error) {
                console.error('Lỗi đăng ký:', error);
                document.getElementById('errorText').textContent = 'Đã xảy ra lỗi. Vui lòng thử lại.';
                document.getElementById('errorMessage').style.display = 'block';
            }
        });

        function showError(elementId, message) {
            document.getElementById(elementId).textContent = message;
        }

        function clearErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.textContent = '';
            });
        }

        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
    </script>
</body>

</html>
